#!/bin/bash

# Controlla se è stato fornito un argomento (il file/cartella da aggiungere)
if [ -z "$1" ]; then
    echo "Errore: Devi specificare il percorso del file o della cartella da aggiungere."
    echo "Uso: ./dotfiles-add /percorso/del/file"
    exit 1
fi

SOURCE_PATH=$1
BASENAME=$(basename "$SOURCE_PATH")
DOTFILES_DIR=~/.dotfiles
DEST_PATH="$DOTFILES_DIR/$BASENAME"
INSTALL_SCRIPT="$DOTFILES_DIR/install.sh"

# --- PASSO 1: Sposta il file/cartella ---
echo "1. Spostamento di '$SOURCE_PATH' in '$DEST_PATH'..."
mv -i "$SOURCE_PATH" "$DEST_PATH"
if [ $? -ne 0 ]; then
    echo "Spostamento fallito. Interruzione."
    exit 1
fi

# --- PASSO 2: Crea il link simbolico ---
echo "2. Creazione del link simbolico..."
if [[ "$SOURCE_PATH" == *".config"* ]]; then
    LINK_TARGET_DIR=~/.config
else
    LINK_TARGET_DIR=~
fi
ln -sfv "$DEST_PATH" "$LINK_TARGET_DIR/$BASENAME"

# --- PASSO 3: Aggiorna lo script install.sh ---
echo "3. Aggiunta del nuovo link allo script 'install.sh'..."
LINK_COMMAND="ln -sfv \"\$DOTFILES_DIR/$BASENAME\" \"$LINK_TARGET_DIR/$BASENAME\""
if ! grep -qF "$LINK_COMMAND" "$INSTALL_SCRIPT"; then
    echo "$LINK_COMMAND" >> "$INSTALL_SCRIPT"
    echo "Script 'install.sh' aggiornato con successo."
else
    echo "Il comando per '$BASENAME' era già presente in 'install.sh'."
fi

# --- NUOVA PARTE: Chiedi conferma per il commit e push ---
echo "" # Aggiunge una linea vuota per leggibilità
read -p "Vuoi fare il commit e il push delle modifiche ora? (y/n) " -n 1 -r
echo "" # Va a capo dopo l'input

if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "OK. Procedo con il commit e il push..."
    cd "$DOTFILES_DIR"
    git add .
    git commit -m "Add $BASENAME config"
    git push
    echo "Sincronizzazione con GitHub completata."
else
    echo "OK. Ricordati di fare il commit manualmente più tardi:"
    echo "  cd ~/.dotfiles"
    echo "  git add ."
    echo "  git commit -m \"Add $BASENAME config\""
    echo "  git push"
fi
